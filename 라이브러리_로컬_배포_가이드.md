# 라이브러리 로컬 배포 가이드

## 개요

이 문서는 Spring Boot 기반의 라이브러리(SDK)를 로컬 Maven 저장소에 배포하는 방법을 단계별로 설명합니다. 우리가 작성한 `ourotail` SDK를 예시로 사용하여 실제 코드와 함께 설명합니다.

## 1. 프로젝트 구조 이해

### 1.1 현재 프로젝트 구조
```
ourotail/
├── build.gradle                    # Gradle 빌드 설정
├── settings.gradle                 # 프로젝트 설정
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/c102/ourotail/
│   │   │       ├── config/
│   │   │       │   └── OurotailAutoConfiguration.java
│   │   │       └── controller/
│   │   │           └── TestController.java
│   │   └── resources/
│   │       └── META-INF/spring/
│   │           └── org.springframework.boot.autoconfigure.AutoConfiguration.imports
│   └── test/
│       └── java/
│           └── com/c102/ourotail/
│               └── config/
│                   └── OurotailAutoConfigurationTest.java
└── build/                          # 빌드 결과물
```

### 1.2 핵심 컴포넌트 설명

#### OurotailAutoConfiguration.java
```java
@AutoConfiguration
@ConditionalOnClass(TestController.class)
public class OurotailAutoConfiguration {

    @Bean
    @ConditionalOnMissingBean
    public TestController testController() {
        return new TestController();
    }
}
```

- `@AutoConfiguration`: Spring Boot 자동 설정 클래스임을 나타냄
- `@ConditionalOnClass`: TestController 클래스가 클래스패스에 있을 때만 활성화
- `@ConditionalOnMissingBean`: 해당 빈이 이미 존재하지 않을 때만 생성

#### TestController.java
```java
@Component
@RestController
@RequestMapping("/api/test")
public class TestController {
    
    @GetMapping("/hello")
    public Map<String, Object> hello() {
        Map<String, Object> response = new HashMap<>();
        response.put("message", "Hello from Ourotail SDK!");
        response.put("status", "success");
        response.put("timestamp", System.currentTimeMillis());
        return response;
    }
    
    // ... 다른 메서드들
}
```

## 2. Gradle 빌드 설정

### 2.1 build.gradle 주요 설정

```gradle
plugins {
    id 'java-library'                    // 라이브러리용 플러그인
    id 'io.spring.dependency-management' version '1.1.7'
}

group = 'com.c102'                       // 그룹 ID
version = '0.0.1-SNAPSHOT'              // 버전
description = 'K6 SDK for Spring Boot'  // 설명

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(17)
    }
    withSourcesJar()                     // 소스 JAR 생성
    withJavadocJar()                     // JavaDoc JAR 생성
}
```

### 2.2 핵심 의존성

```gradle
dependencies {
    // 자동 설정을 위한 핵심 의존성
    implementation 'org.springframework.boot:spring-boot-autoconfigure'
    
    // 웹 컨트롤러 사용을 위한 의존성 (Tomcat 없음)
    implementation 'org.springframework:spring-web'
    
    // 설정 프로퍼티 처리
    implementation 'org.springframework.boot:spring-boot-configuration-processor'
    annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor'
    
    // 로깅 인터페이스 (구현체는 사용자가 선택)
    compileOnly 'org.slf4j:slf4j-api'
    
    // 테스트 의존성
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
}
```

### 2.3 Maven 배포 설정

```gradle
apply plugin: 'maven-publish'

publishing {
    publications {
        maven(MavenPublication) {
            from components.java
            
            groupId = 'com.c102'
            artifactId = 'ourotail-sdk'
            version = '0.0.1-SNAPSHOT'
            
            pom {
                name = 'Ourotail SDK'
                description = 'K6 SDK for Spring Boot'
                url = 'https://github.com/your-org/ourotail-sdk'
                
                licenses {
                    license {
                        name = 'The Apache License, Version 2.0'
                        url = 'http://www.apache.org/licenses/LICENSE-2.0.txt'
                    }
                }
            }
        }
    }
    
    repositories {
        mavenLocal()  // 로컬 Maven 저장소에 배포
    }
}
```

## 3. 자동 설정 등록

### 3.1 AutoConfiguration.imports 파일

`src/main/resources/META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports` 파일에 자동 설정 클래스를 등록:

```
com.c102.ourotail.config.OurotailAutoConfiguration
```

이 파일은 Spring Boot가 자동으로 스캔하여 자동 설정을 활성화합니다.

## 4. 로컬 배포 과정

### 4.1 빌드 및 테스트

```bash
# 프로젝트 루트 디렉토리에서 실행
./gradlew clean build
```

실행 결과:
- `build/libs/ourotail-0.0.1-SNAPSHOT.jar` - 메인 JAR 파일
- `build/libs/ourotail-0.0.1-SNAPSHOT-sources.jar` - 소스 JAR 파일
- `build/libs/ourotail-0.0.1-SNAPSHOT-javadoc.jar` - JavaDoc JAR 파일

### 4.2 로컬 Maven 저장소에 배포

```bash
./gradlew publishToMavenLocal
```

이 명령어는 다음 위치에 라이브러리를 배포합니다:
- Windows: `C:\Users\{사용자명}\.m2\repository\com\c102\ourotail-sdk\0.0.1-SNAPSHOT\`
- macOS/Linux: `~/.m2/repository/com/c102/ourotail-sdk/0.0.1-SNAPSHOT/`

### 4.3 배포 확인

로컬 Maven 저장소에 다음 파일들이 생성되었는지 확인:

```
~/.m2/repository/com/c102/ourotail-sdk/0.0.1-SNAPSHOT/
├── ourotail-sdk-0.0.1-SNAPSHOT.jar
├── ourotail-sdk-0.0.1-SNAPSHOT-sources.jar
├── ourotail-sdk-0.0.1-SNAPSHOT-javadoc.jar
├── ourotail-sdk-0.0.1-SNAPSHOT.pom
└── maven-metadata-local.xml
```

## 5. 다른 프로젝트에서 사용하기

### 5.1 의존성 추가

다른 Spring Boot 프로젝트의 `build.gradle`에 의존성 추가:

```gradle
dependencies {
    implementation 'com.c102:ourotail-sdk:0.0.1-SNAPSHOT'
    
    // Spring Boot 애플리케이션 의존성
    implementation 'org.springframework.boot:spring-boot-starter-web'
}
```

### 5.2 자동 설정 활성화

Spring Boot 애플리케이션에서 자동 설정이 활성화되면, `TestController`가 자동으로 등록됩니다.

### 5.3 API 테스트

애플리케이션 실행 후 다음 엔드포인트들을 테스트할 수 있습니다:

```bash
# GET 요청 테스트
curl http://localhost:8080/api/test/hello

# 응답 예시
{
  "message": "Hello from Ourotail SDK!",
  "status": "success",
  "timestamp": 1703123456789
}

# POST 요청 테스트
curl -X POST http://localhost:8080/api/test/echo \
  -H "Content-Type: application/json" \
  -d '{"test": "data"}'

# SDK 정보 조회
curl http://localhost:8080/api/test/info
```

## 6. 테스트 작성

### 6.1 자동 설정 테스트

```java
@SpringBootTest(classes = {OurotailAutoConfigurationTest.TestConfig.class, OurotailAutoConfiguration.class})
class OurotailAutoConfigurationTest {

    @Configuration
    static class TestConfig {
        // 테스트용 설정
    }

    @Test
    void contextLoads() {
        // 자동 설정이 정상적으로 로드되는지 확인
    }
}
```

### 6.2 통합 테스트

```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
class TestControllerIntegrationTest {

    @Autowired
    private TestRestTemplate restTemplate;

    @Test
    void testHelloEndpoint() {
        ResponseEntity<Map> response = restTemplate.getForEntity("/api/test/hello", Map.class);
        
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody().get("message")).isEqualTo("Hello from Ourotail SDK!");
    }
}
```

## 7. 버전 관리

### 7.1 버전 변경

`build.gradle`에서 버전을 변경:

```gradle
version = '0.0.2-SNAPSHOT'  // 새 버전으로 변경
```

### 7.2 재배포

```bash
./gradlew clean publishToMavenLocal
```

## 8. 문제 해결

### 8.1 자동 설정이 작동하지 않는 경우

1. `AutoConfiguration.imports` 파일이 올바른 위치에 있는지 확인
2. 클래스패스에 필요한 의존성이 있는지 확인
3. `@ConditionalOnClass` 조건이 만족되는지 확인

### 8.2 의존성 충돌

```gradle
// 특정 버전 강제 지정
configurations.all {
    resolutionStrategy {
        force 'org.springframework:spring-web:6.0.13'
    }
}
```

### 8.3 빌드 실패

```bash
# 상세한 빌드 정보 확인
./gradlew build --info

# 의존성 트리 확인
./gradlew dependencies
```

## 9. 고급 설정

### 9.1 프로파일별 설정

```gradle
publishing {
    publications {
        maven(MavenPublication) {
            from components.java
            
            // 프로파일별 설정
            if (project.hasProperty('release')) {
                version = '1.0.0'
            } else {
                version = '1.0.0-SNAPSHOT'
            }
        }
    }
}
```

### 9.2 서명 설정

```gradle
apply plugin: 'signing'

signing {
    sign publishing.publications.maven
}
```

## 10. 배포 체크리스트

- [ ] `build.gradle` 설정 완료
- [ ] 자동 설정 클래스 작성
- [ ] `AutoConfiguration.imports` 파일 등록
- [ ] 테스트 코드 작성 및 통과
- [ ] 로컬 빌드 성공
- [ ] 로컬 Maven 저장소 배포 성공
- [ ] 다른 프로젝트에서 의존성 추가 및 테스트 성공

## 결론

이 가이드를 따라하면 Spring Boot 기반의 라이브러리를 로컬 Maven 저장소에 성공적으로 배포할 수 있습니다. 실제 프로덕션 환경에서는 Maven Central이나 사설 저장소를 사용하는 것을 권장합니다.

라이브러리 개발 시에는 항상 테스트를 작성하고, 문서화를 철저히 하며, 버전 관리를 체계적으로 하는 것이 중요합니다.
